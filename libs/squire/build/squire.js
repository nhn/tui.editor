var UA=function(e){"use strict";var t=navigator.userAgent,n=!!e.opera,r=/Trident\//.test(t),i=/WebKit\//.test(t);return{isOpera:n,isIE8:8===e.ie,isIE:r,isGecko:/Gecko\//.test(t),isWebKit:i,isIOS:/iP(?:ad|hone|od)/.test(t),useTextFixer:r||n,cantFocusEmptyTextNodes:r||i,losesSelectionOnBlur:r}}(window),DOMTreeWalker=function(){"use strict";var e={1:1,2:2,3:4,8:128,9:256,11:1024},t=1,n=function(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n};return n.prototype.nextNode=function(){for(var n,r=this.currentNode,i=this.root,o=this.nodeType,s=this.filter;;){for(n=r.firstChild;!n&&r&&r!==i;)n=r.nextSibling,n||(r=r.parentNode);if(!n)return null;if(e[n.nodeType]&o&&s(n)===t)return this.currentNode=n,n;r=n}},n.prototype.previousNode=function(){for(var n,r=this.currentNode,i=this.root,o=this.nodeType,s=this.filter;;){if(r===i)return null;if(n=r.previousSibling)for(;r=n.lastChild;)n=r;else n=r.parentNode;if(!n)return null;if(e[n.nodeType]&o&&s(n)===t)return this.currentNode=n,n;r=n}},n}();(function(e,t){"use strict";var n=function(e,t){for(var n,r,i=e.length;i--;){n=e[i].prototype;for(r in t)n[r]=t[r]}},r=function(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0},i=function(){return!1},o=function(){return!0},s=/^(?:A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:FN|EL)|EM|FONT|HR|I(?:NPUT|MG|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:U[BP]|PAN|TRONG|AMP)|U)$/,a={BR:1,IMG:1,INPUT:1},l=function(e,t){var n=t.parentNode;return n&&n.replaceChild(e,t),e},d=1,c=3,f=1,u=1,h=3,p=function(e){return e.isBlock()?u:h};n(window.Node?[Node]:[Text,Element,HTMLDocument],{isLeaf:i,isInline:i,isBlock:i,isContainer:i,getPath:function(){var e=this.parentNode;return e?e.getPath():""},detach:function(){var e=this.parentNode;return e&&e.removeChild(this),this},replaceWith:function(e){return l(e,this),this},replaces:function(e){return l(this,e),this},nearest:function(e,t){var n=this.parentNode;return n?n.nearest(e,t):null},getPreviousBlock:function(){var e=this.ownerDocument,n=new t(e.body,f,p,!1);return n.currentNode=this,n.previousNode()},getNextBlock:function(){var e=this.ownerDocument,n=new t(e.body,f,p,!1);return n.currentNode=this,n.nextNode()},split:function(e){return e},mergeContainers:function(){}}),n([Text],{isInline:o,getLength:function(){return this.length},isLike:function(e){return e.nodeType===c},split:function(e,t){var n=this;return n===t?e:n.parentNode.split(n.splitText(e),t)}}),n([Element],{isLeaf:function(){return!!a[this.nodeName]},isInline:function(){return s.test(this.nodeName)},isBlock:function(){return!this.isInline()&&r(this.childNodes,function(e){return e.isInline()})},isContainer:function(){return!this.isInline()&&!this.isBlock()},getLength:function(){return this.childNodes.length},getPath:function(){var e,t,n,r,i=this.parentNode;return i?(e=i.getPath(),e+=(e?">":"")+this.nodeName,(t=this.id)&&(e+="#"+t),(n=this.className.trim())&&(r=n.split(/\s\s*/),r.sort(),e+=".",e+=r.join(".")),e):""},wraps:function(e){return l(this,e).appendChild(e),this},empty:function(){for(var e=this.ownerDocument.createDocumentFragment(),t=this.childNodes.length;t--;)e.appendChild(this.firstChild);return e},is:function(e,t){if(this.nodeName!==e)return!1;var n;for(n in t)if(this.getAttribute(n)!==t[n])return!1;return!0},nearest:function(e,t){var n=this;do if(n.is(e,t))return n;while((n=n.parentNode)&&n.nodeType===d);return null},isLike:function(e){return e.nodeType===d&&e.nodeName===this.nodeName&&e.className===this.className&&e.style.cssText===this.style.cssText},mergeInlines:function(e){for(var t,n,r,i=this.childNodes,o=i.length,s=[];o--;)if(t=i[o],n=o&&i[o-1],o&&t.isInline()&&t.isLike(n)&&!a[t.nodeName])e.startContainer===t&&(e.startContainer=n,e.startOffset+=n.getLength()),e.endContainer===t&&(e.endContainer=n,e.endOffset+=n.getLength()),e.startContainer===this&&(e.startOffset>o?e.startOffset-=1:e.startOffset===o&&(e.startContainer=n,e.startOffset=n.getLength())),e.endContainer===this&&(e.endOffset>o?e.endOffset-=1:e.endOffset===o&&(e.endContainer=n,e.endOffset=n.getLength())),t.detach(),t.nodeType===c?n.appendData(t.data.replace(/\u200B/g,"")):s.push(t.empty());else if(t.nodeType===d){for(r=s.length;r--;)t.appendChild(s.pop());t.mergeInlines(e)}},mergeWithBlock:function(e,t){for(var n,r,i,o=this,s=e;1===s.parentNode.childNodes.length;)s=s.parentNode;s.detach(),r=o.childNodes.length,n=o.lastChild,n&&"BR"===n.nodeName&&(o.removeChild(n),r-=1),i={startContainer:o,startOffset:r,endContainer:o,endOffset:r},o.appendChild(e.empty()),o.mergeInlines(i),t.setStart(i.startContainer,i.startOffset),t.collapse(!0),window.opera&&(n=o.lastChild)&&"BR"===n.nodeName&&o.removeChild(n)},mergeContainers:function(){var e=this.previousSibling,t=this.firstChild;e&&e.isLike(this)&&e.isContainer()&&(e.appendChild(this.detach().empty()),t&&t.mergeContainers())},split:function(e,t){var n=this;if("number"==typeof e&&(e=n.childNodes.length>e?n.childNodes[e]:null),n===t)return e;for(var r,i=n.parentNode,o=n.cloneNode(!1);e;)r=e.nextSibling,o.appendChild(e),e=r;return n.fixCursor(),o.fixCursor(),(r=n.nextSibling)?i.insertBefore(o,r):i.appendChild(o),i.split(o,t)},fixCursor:function(){var t,n,r=this,i=r.ownerDocument;if("BODY"===r.nodeName&&((n=r.firstChild)&&"BR"!==n.nodeName||(t=i.createElement("DIV"),n?r.replaceChild(t,n):r.appendChild(t),r=t,t=null)),r.isInline())r.firstChild||(e.cantFocusEmptyTextNodes?(t=i.createTextNode("​"),editor._setPlaceholderTextNode(t)):t=i.createTextNode(""));else if(e.useTextFixer){for(;r.nodeType!==c&&!r.isLeaf();){if(n=r.firstChild,!n){t=i.createTextNode("");break}r=n}r.nodeType===c?/^ +$/.test(r.data)&&(r.data=""):r.isLeaf()&&r.parentNode.insertBefore(i.createTextNode(""),r)}else if(!r.querySelector("BR"))for(t=i.createElement("BR");(n=r.lastElementChild)&&!n.isInline();)r=n;return t&&r.appendChild(t),this}}),function(){var e=document.createElement("div"),t=document.createTextNode("12");return e.appendChild(t),t.splitText(2),2!==e.childNodes.length}()&&(Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,r=this.parentNode,i=this.length-e;return n?r.insertBefore(t,n):r.appendChild(t),i&&this.deleteData(e,i),t})})(UA,DOMTreeWalker),function(e){"use strict";var t,n=Array.prototype.indexOf,r=1,i=3,o=4,s=1,a=0,l=1,d=2,c=3,f=function(e,t){for(var n=e.childNodes;t&&e.nodeType===r;)e=n[t-1],n=e.childNodes,t=n.length;return e},u=function(e,t){if(e.nodeType===r){var n=e.childNodes;if(n.length>t)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},h={forEachTextNode:function(t){var n=this.cloneRange();n.moveBoundariesDownTree();for(var r=n.startContainer,i=n.endContainer,a=n.commonAncestorContainer,l=new e(a,o,function(){return s},!1),d=l.currentNode=r;!t(d,n)&&d!==i&&(d=l.nextNode()););},getTextContent:function(){var e="";return this.forEachTextNode(function(t,n){var r=t.data;r&&/\S/.test(r)&&(t===n.endContainer&&(r=r.slice(0,n.endOffset)),t===n.startContainer&&(r=r.slice(n.startOffset)),e+=r)}),e},_insertNode:function(e){var t,r,o,s,a=this.startContainer,l=this.startOffset,d=this.endContainer,c=this.endOffset;return a.nodeType===i?(t=a.parentNode,r=t.childNodes,l===a.length?(l=n.call(r,a)+1,this.collapsed&&(d=t,c=l)):(l&&(s=a.splitText(l),d===a?(c-=l,d=s):d===t&&(c+=1),a=s),l=n.call(r,a)),a=t):r=a.childNodes,o=r.length,l===o?a.appendChild(e):a.insertBefore(e,r[l]),a===d&&(c+=r.length-o),this.setStart(a,l),this.setEnd(d,c),this},_extractContents:function(e){var t=this.startContainer,r=this.startOffset,o=this.endContainer,s=this.endOffset;e||(e=this.commonAncestorContainer),e.nodeType===i&&(e=e.parentNode);for(var a,l=o.split(s,e),d=t.split(r,e),c=e.ownerDocument.createDocumentFragment();d!==l;)a=d.nextSibling,c.appendChild(d),d=a;return this.setStart(e,l?n.call(e.childNodes,l):e.childNodes.length),this.collapse(!0),e.fixCursor(),c},_deleteContents:function(){this.moveBoundariesUpTree(),this._extractContents();var e=this.getStartBlock(),t=this.getEndBlock();e&&t&&e!==t&&e.mergeWithBlock(t,this),e&&e.fixCursor();var n=this.endContainer.ownerDocument.body,r=n.firstChild;r&&"BR"!==r.nodeName||(n.fixCursor(),this.selectNodeContents(n.firstChild));var i=this.collapsed;return this.moveBoundariesDownTree(),i&&this.collapse(!0),this},insertTreeFragment:function(e){for(var t=!0,n=e.childNodes,i=n.length;i--;)if(!n[i].isInline()){t=!1;break}if(this.collapsed||this._deleteContents(),this.moveBoundariesDownTree(),t)this._insertNode(e),this.collapse(!1);else{for(var o,s,a=this.startContainer.split(this.startOffset,this.startContainer.ownerDocument.body),l=a.previousSibling,d=l,c=d.childNodes.length,f=a,u=0,h=a.parentNode;(o=d.lastChild)&&o.nodeType===r&&"BR"!==o.nodeName;)d=o,c=d.childNodes.length;for(;(o=f.firstChild)&&o.nodeType===r&&"BR"!==o.nodeName;)f=o;for(;(o=e.firstChild)&&o.isInline();)d.appendChild(o);for(;(o=e.lastChild)&&o.isInline();)f.insertBefore(o,f.firstChild),u+=1;for(s=e;s=s.getNextBlock();)s.fixCursor();h.insertBefore(e,a),s=a.previousSibling,a.textContent?a.mergeContainers():h.removeChild(a),a.parentNode||(f=s,u=f.getLength()),l.textContent?l.mergeContainers():(d=l.nextSibling,c=0,h.removeChild(l)),this.setStart(d,c),this.setEnd(f,u),this.moveBoundariesDownTree()}},containsNode:function(e,t){var n=this,r=e.ownerDocument.createRange();if(r.selectNode(e),t){var i=n.compareBoundaryPoints(c,r)>-1,o=1>n.compareBoundaryPoints(l,r);return!i&&!o}var s=1>n.compareBoundaryPoints(a,r),f=n.compareBoundaryPoints(d,r)>-1;return s&&f},moveBoundariesDownTree:function(){for(var e,t=this.startContainer,n=this.startOffset,r=this.endContainer,o=this.endOffset;t.nodeType!==i&&(e=t.childNodes[n],e&&!e.isLeaf());)t=e,n=0;if(o)for(;r.nodeType!==i&&(e=r.childNodes[o-1],e&&!e.isLeaf());)r=e,o=r.getLength();else for(;r.nodeType!==i&&(e=r.firstChild,e&&!e.isLeaf());)r=e;return this.collapsed?(this.setStart(r,o),this.setEnd(t,n)):(this.setStart(t,n),this.setEnd(r,o)),this},moveBoundariesUpTree:function(e){var t,r=this.startContainer,i=this.startOffset,o=this.endContainer,s=this.endOffset;for(e||(e=this.commonAncestorContainer);r!==e&&!i;)t=r.parentNode,i=n.call(t.childNodes,r),r=t;for(;o!==e&&s===o.getLength();)t=o.parentNode,s=n.call(t.childNodes,o)+1,o=t;return this.setStart(r,i),this.setEnd(o,s),this},getStartBlock:function(){var e,t=this.startContainer;return t.isInline()?e=t.getPreviousBlock():t.isBlock()?e=t:(e=f(t,this.startOffset),e=e.getNextBlock()),e&&this.containsNode(e,!0)?e:null},getEndBlock:function(){var e,t,n=this.endContainer;if(n.isInline())e=n.getPreviousBlock();else if(n.isBlock())e=n;else{if(e=u(n,this.endOffset),!e)for(e=n.ownerDocument.body;t=e.lastChild;)e=t;e=e.getPreviousBlock()}return e&&this.containsNode(e,!0)?e:null},startsAtBlockBoundary:function(){for(var e,t,r=this.startContainer,i=this.startOffset;r.isInline();){if(i)return!1;e=r.parentNode,i=n.call(e.childNodes,r),r=e}for(;i&&(t=r.childNodes[i-1])&&(""===t.data||"BR"===t.nodeName);)i-=1;return!i},endsAtBlockBoundary:function(){for(var e,t,r=this.endContainer,i=this.endOffset,o=r.getLength();r.isInline();){if(i!==o)return!1;e=r.parentNode,i=n.call(e.childNodes,r)+1,r=e,o=r.childNodes.length}for(;o>i&&(t=r.childNodes[i])&&(""===t.data||"BR"===t.nodeName);)i+=1;return i===o},expandToBlockBoundaries:function(){var e,t=this.getStartBlock(),r=this.getEndBlock();return t&&r&&(e=t.parentNode,this.setStart(e,n.call(e.childNodes,t)),e=r.parentNode,this.setEnd(e,n.call(e.childNodes,r)+1)),this}};for(t in h)Range.prototype[t]=h[t]}(DOMTreeWalker),function(e,t,n){"use strict";var r,i=2,o=1,s=3,a=1,l=4,d=1,c=3,f=e.defaultView,u=e.body,h=t.isOpera,p=t.isGecko,N=t.isIOS,g=t.isIE,C=t.isIE8,m=t.cantFocusEmptyTextNodes,v=t.losesSelectionOnBlur,y=t.useTextFixer,T=/\S/,B=function(t,n,r){var i,o,s,a=e.createElement(t);if(n instanceof Array&&(r=n,n=null),n)for(i in n)a.setAttribute(i,n[i]);if(r)for(o=0,s=r.length;s>o;o+=1)a.appendChild(r[o]);return a},x={focus:1,blur:1,pathChange:1,select:1,input:1,undoStateChange:1},O={},S=function(e,t){var n,i,o,s=O[e];if(s)for(t||(t={}),t.type!==e&&(t.type=e),n=0,i=s.length;i>n;n+=1){o=s[n];try{o.handleEvent?o.handleEvent(t):o(t)}catch(a){r.didError(a)}}},I=function(e){S(e.type,e)},E=function(t,n){var r=O[t];r||(r=O[t]=[],x[t]||e.addEventListener(t,I,!1)),r.push(n)},D=function(t,n){var r,i=O[t];if(i){for(r=i.length;r--;)i[r]===n&&i.splice(r,1);i.length||(delete O[t],x[t]||e.removeEventListener(t,I,!1))}},k=function(t,n,r,i){if(t instanceof Range)return t.cloneRange();var o=e.createRange();return o.setStart(t,n),r?o.setEnd(r,i):o.setEnd(t,n),o},b=f.getSelection(),L=null,A=function(e){e&&(N&&f.focus(),b.removeAllRanges(),b.addRange(e))},w=function(){if(b.rangeCount){L=b.getRangeAt(0).cloneRange();var e=L.startContainer,t=L.endContainer;e&&e.isLeaf()&&L.setStartBefore(e),t&&t.isLeaf()&&L.setEndBefore(t)}return L};v&&f.addEventListener("beforedeactivate",w,!0);var P,R,U=null,V=!0,F=!1,H=function(){V=!0,F=!1},W=function(e){U&&(V=!0,_()),F||(setTimeout(H,0),F=!0),V=!1,U=e},_=function(){if(V){var e,t=U;if(U=null,t.parentNode){for(;(e=t.data.indexOf("​"))>-1;)t.deleteData(e,1);t.data||t.nextSibling||t.previousSibling||!t.parentNode.isInline()||t.parentNode.detach()}}},M="",z=function(e,t){U&&!t&&_(e);var n,r=e.startContainer,i=e.endContainer;(t||r!==P||i!==R)&&(P=r,R=i,n=r&&i?r===i?i.getPath():"(selection)":"",M!==n&&(M=n,S("pathChange",{path:n}))),r!==i&&S("select")},K=function(){z(w())};E("keyup",K),E("mouseup",K);var q=function(){p&&u.focus(),f.focus()},G=function(){p&&u.blur(),top.focus()};f.addEventListener("focus",I,!1),f.addEventListener("blur",I,!1);var Q,Y,$,j,Z=function(){return u.innerHTML},J=function(e){var t=u;t.innerHTML=e;do t.fixCursor();while(t=t.getNextBlock())},X=function(e,t){t||(t=w()),t.collapse(!0),t._insertNode(e),t.setStartAfter(e),A(t),z(t)},et=Array.prototype.indexOf,tt="squire-selection-start",nt="squire-selection-end",rt=function(e){var t,n=B("INPUT",{id:tt,type:"hidden"}),r=B("INPUT",{id:nt,type:"hidden"});e._insertNode(n),e.collapse(!1),e._insertNode(r),n.compareDocumentPosition(r)&i&&(n.id=nt,r.id=tt,t=n,n=r,r=t),e.setStartAfter(n),e.setEndBefore(r)},it=function(t){var n=e.getElementById(tt),r=e.getElementById(nt);if(n&&r){var i,o=n.parentNode,s=r.parentNode,a={startContainer:o,endContainer:s,startOffset:et.call(o.childNodes,n),endOffset:et.call(s.childNodes,r)};o===s&&(a.endOffset-=1),n.detach(),r.detach(),o.mergeInlines(a),o!==s&&s.mergeInlines(a),t||(t=e.createRange()),t.setStart(a.startContainer,a.startOffset),t.setEnd(a.endContainer,a.endOffset),i=t.collapsed,t.moveBoundariesDownTree(),i&&t.collapse(!0)}return t||null},ot=function(){j&&(j=!1,S("undoStateChange",{canUndo:!0,canRedo:!1})),S("input")};E("keyup",function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(16>t||t>20)||!(33>t||t>45)||ot()});var st=function(e){j||(Q+=1,$>Q&&(Y.length=$=Q),e&&rt(e),Y[Q]=Z(),$+=1,j=!0)},at=function(){if(0!==Q||!j){st(w()),Q-=1,J(Y[Q]);var e=it();e&&A(e),j=!0,S("undoStateChange",{canUndo:0!==Q,canRedo:!0}),S("input")}},lt=function(){if($>Q+1&&j){Q+=1,J(Y[Q]);var e=it();e&&A(e),S("undoStateChange",{canUndo:!0,canRedo:$>Q+1}),S("input")}},dt=function(e,t,r){if(e=e.toUpperCase(),t||(t={}),!r&&!(r=w()))return!1;var i,o,a=r.commonAncestorContainer;if(a.nearest(e,t))return!0;if(a.nodeType===s)return!1;i=new n(a,l,function(e){return r.containsNode(e,!0)?d:c},!1);for(var f=!1;o=i.nextNode();){if(!o.nearest(e,t))return!1;f=!0}return f},ct=function(e,t,r){if(r.collapsed){var i=B(e,t).fixCursor();r._insertNode(i),r.setStart(i.firstChild,i.firstChild.length),r.collapse(!0)}else{var o,a,f,u=new n(r.commonAncestorContainer,l,function(e){return r.containsNode(e,!0)?d:c},!1),h=0,p=0,N=u.currentNode=r.startContainer;N.nodeType!==s&&(N=u.nextNode());do f=!N.nearest(e,t),N===r.endContainer&&(f&&N.length>r.endOffset?N.splitText(r.endOffset):p=r.endOffset),N===r.startContainer&&(f&&r.startOffset?N=N.splitText(r.startOffset):h=r.startOffset),f&&(B(e,t).wraps(N),p=N.length),a=N,o||(o=a);while(N=u.nextNode());r=k(o,h,a,p)}return r},ft=function(t,n,r,i){rt(r);var o;r.collapsed&&(m?(o=e.createTextNode("​"),W(o)):o=e.createTextNode(""),r._insertNode(o));for(var a=r.commonAncestorContainer;a.isInline();)a=a.parentNode;var l=r.startContainer,d=r.startOffset,c=r.endContainer,f=r.endOffset,u=[],h=function(e,t){if(!r.containsNode(e,!1)){var n,i,o=e.nodeType===s;if(!r.containsNode(e,!0))return"INPUT"===e.nodeName||o&&!e.data||u.push([t,e]),void 0;if(o)e===c&&f!==e.length&&u.push([t,e.splitText(f)]),e===l&&d&&(e.splitText(d),u.push([t,e]));else for(n=e.firstChild;n;n=i)i=n.nextSibling,h(n,t)}},p=Array.prototype.filter.call(a.getElementsByTagName(t),function(e){return r.containsNode(e,!0)&&e.is(t,n)});i||p.forEach(function(e){h(e,e)}),u.forEach(function(e){e[0].cloneNode(!1).wraps(e[1])}),p.forEach(function(e){e.replaceWith(e.empty())}),it(r),o&&r.collapse(!1);var N={startContainer:r.startContainer,startOffset:r.startOffset,endContainer:r.endContainer,endOffset:r.endOffset};return a.mergeInlines(N),r.setStart(N.startContainer,N.startOffset),r.setEnd(N.endContainer,N.endOffset),r},ut=function(e,t,n,r){(n||(n=w()))&&(st(n),it(n),t&&(n=ft(t.tag.toUpperCase(),t.attributes||{},n,r)),e&&(n=ct(e.tag.toUpperCase(),e.attributes||{},n)),A(n),z(n,!0),ot())},ht={DIV:"DIV",PRE:"DIV",H1:"DIV",H2:"DIV",H3:"DIV",H4:"DIV",H5:"DIV",H6:"DIV",P:"DIV",DT:"DD",DD:"DT",LI:"LI"},pt=function(e,t,n){var r=ht[e.nodeName],i=t.split(n,e.parentNode);return i.nodeName!==r&&(e=B(r),e.className="rtl"===i.dir?"dir-rtl":"",e.dir=i.dir,e.replaces(i).appendChild(i.empty()),i=e),i},Nt=function(e,t,n){if(n||(n=w())){t&&(st(n),it(n));var r=n.getStartBlock(),i=n.getEndBlock();if(r&&i)do if(e(r)||r===i)break;while(r=r.getNextBlock());t&&(A(n),z(n,!0),ot())}},gt=function(e,t){if(t||(t=w())){h||u.setAttribute("contenteditable","false"),j?rt(t):st(t),t.expandToBlockBoundaries(),t.moveBoundariesUpTree(u);var n=t._extractContents(u);t._insertNode(e(n)),t.endOffset<t.endContainer.childNodes.length&&t.endContainer.childNodes[t.endOffset].mergeContainers(),t.startContainer.childNodes[t.startOffset].mergeContainers(),h||u.setAttribute("contenteditable","true"),it(t),A(t),z(t,!0),ot()}},Ct=function(e){return B("BLOCKQUOTE",[e])},mt=function(e){var t=e.querySelectorAll("blockquote");return Array.prototype.filter.call(t,function(e){return!e.parentNode.nearest("BLOCKQUOTE")}).forEach(function(e){e.replaceWith(e.empty())}),e},vt=function(e){for(var t,n=e.querySelectorAll("blockquote"),r=n.length;r--;)t=n[r],t.replaceWith(t.empty());return e},yt=function(e,t){var n,r,i,o,s,a;for(n=0,r=e.length;r>n;n+=1)i=e[n],o=i.nodeName,i.isBlock()?"LI"!==o&&(a=B("LI",{"class":"rtl"===i.dir?"dir-rtl":"",dir:i.dir},[i.empty()]),i.parentNode.nodeName===t?i.replaceWith(a):(s=i.previousSibling)&&s.nodeName===t?(s.appendChild(a),i.detach(),n-=1,r-=1):i.replaceWith(B(t,[a]))):i.isContainer()&&(o!==t&&/^[DOU]L$/.test(o)?i.replaceWith(B(t,[i.empty()])):yt(i.childNodes,t))},Tt=function(e){return yt(e.childNodes,"UL"),e},Bt=function(e){return yt(e.childNodes,"OL"),e},xt=function(e){var t=e.querySelectorAll("UL, OL");return Array.prototype.filter.call(t,function(e){return!e.parentNode.nearest("UL")&&!e.parentNode.nearest("OL")}).forEach(function(e){for(var t,n=e.empty(),r=n.childNodes,i=r.length;i--;)t=r[i],"LI"===t.nodeName&&n.replaceChild(B("DIV",{"class":"rtl"===t.dir?"dir-rtl":"",dir:t.dir},[t.empty()]),t);e.replaceWith(n)}),e},Ot=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’])|(?:[\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,4}))/i,St=function(e){for(var t,r,i,o,s,a,f,u=e.ownerDocument,h=new n(e,l,function(e){return e.nearest("A")?c:d},!1);t=h.nextNode();)if(r=t.data.split(Ot),o=r.length,o>1){for(a=t.parentNode,f=t.nextSibling,i=0;o>i;i+=1)s=r[i],i?(i%2?(t=u.createElement("A"),t.textContent=s,t.href=/@/.test(s)?"mailto:"+s:/^(?:ht|f)tps?:/.test(s)?s:"http://"+s):t=u.createTextNode(s),f?a.insertBefore(t,f):a.appendChild(t)):t.data=s;h.currentNode=t}},It=/^(?:A(?:DDRESS|RTICLE|SIDE)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|UL)$/,Et={1:10,2:13,3:16,4:18,5:24,6:32,7:48},Dt={backgroundColor:{regexp:T,replace:function(e){return B("SPAN",{"class":"highlight",style:"background-color: "+e})}},color:{regexp:T,replace:function(e){return B("SPAN",{"class":"colour",style:"color:"+e})}},fontWeight:{regexp:/^bold/i,replace:function(){return B("B")}},fontStyle:{regexp:/^italic/i,replace:function(){return B("I")}},fontFamily:{regexp:T,replace:function(e){return B("SPAN",{"class":"font",style:"font-family:"+e})}},fontSize:{regexp:T,replace:function(e){return B("SPAN",{"class":"size",style:"font-size:"+e})}}},kt={SPAN:function(e,t){var n,r,i,o,s,a,l=e.style;for(n in Dt)r=Dt[n],i=l[n],i&&r.regexp.test(i)&&(a=r.replace(i),o&&o.appendChild(a),o=a,s||(s=a));return s&&(o.appendChild(e.empty()),t.replaceChild(s,e)),o||e},STRONG:function(e,t){var n=B("B");return t.replaceChild(n,e),n.appendChild(e.empty()),n},EM:function(e,t){var n=B("I");return t.replaceChild(n,e),n.appendChild(e.empty()),n},FONT:function(e,t){var n,r,i,o,s=e.face,a=e.size;return s&&(n=B("SPAN",{"class":"font",style:"font-family:"+s})),a&&(r=B("SPAN",{"class":"size",style:"font-size:"+Et[a]+"px"}),n&&n.appendChild(r)),o=n||r||B("SPAN"),i=r||n||o,t.replaceChild(o,e),i.appendChild(e.empty()),i},TT:function(e,t){var n=B("SPAN",{"class":"font",style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(e.empty()),n}},bt=function(e){for(var t,n=e.childNodes,r=n.length;r--;)t=n[r],t.nodeType===o&&(bt(t),t.isInline()&&!t.firstChild&&e.removeChild(t))},Lt=function(e,t){var n,r,i,a,l,d,c,f=e.childNodes;for(n=0,r=f.length;r>n;n+=1)if(i=f[n],a=i.nodeName,l=i.nodeType,d=kt[a],l===o){if(c=i.childNodes.length,d)i=d(i,e);else{if(!It.test(a)&&!i.isInline()){n-=1,r+=c-1,e.replaceChild(i.empty(),i);continue}!t&&i.style.cssText&&i.removeAttribute("style")}c&&Lt(i,t)}else l===s&&(T.test(i.data)||n>0&&f[n-1].isInline()||r>n+1&&f[n+1].isInline())||(e.removeChild(i),n-=1,r-=1);return e},At=function(e,t){var n,r,i,o,s=e.childNodes,a=null;for(n=0,r=s.length;r>n;n+=1)i=s[n],o="BR"===i.nodeName,!o&&i.isInline()?(a||(a=B(t)),a.appendChild(i),n-=1,r-=1):(o||a)&&(a||(a=B(t)),a.fixCursor(),o?e.replaceChild(a,i):(e.insertBefore(a,i),n+=1,r+=1),a=null);return a&&e.appendChild(a.fixCursor()),e},wt=function(e){return(e.nodeType===o?"BR"===e.nodeName:T.test(e.data))?d:c},Pt=function(e){for(var t,r=e.parentNode;r.isInline();)r=r.parentNode;return t=new n(r,a|l,wt),t.currentNode=e,!!t.nextNode()},Rt=function(e){var t,n,r,i=e.querySelectorAll("BR"),o=[],s=i.length;for(t=0;s>t;t+=1)o[t]=Pt(i[t]);for(;s--;)if(n=i[s],r=n.parentNode){for(;r.isInline();)r=r.parentNode;r.isBlock()&&ht[r.nodeName]?(o[s]&&pt(r,n.parentNode,n),n.detach()):At(r,"DIV")}},Ut=function(){try{u.fixCursor()}catch(e){r.didError(e)}};E(g?"beforecut":"cut",function(){var e=w();st(e),it(e),A(e),setTimeout(Ut,0)});var Vt=!1;E(g?"beforepaste":"paste",function(e){if(!Vt){var t,n=e.clipboardData,i=n&&n.items,o=!1;if(i)for(t=i.length;t--;)if(/^image\/.*/.test(i[t].type))return e.preventDefault(),S("dragover",{dataTransfer:n,preventDefault:function(){o=!0}}),o&&S("drop",{dataTransfer:n}),void 0;Vt=!0;var s=w(),a=s.startContainer,l=s.startOffset,d=s.endContainer,c=s.endOffset,f=B("DIV",{style:"position: absolute; overflow: hidden; top:"+(u.scrollTop+30)+"px; left: 0; width: 1px; height: 1px;"});u.appendChild(f),s.selectNodeContents(f),A(s),setTimeout(function(){try{var e=f.detach().empty(),t=e.firstChild,n=k(a,l,d,c);if(t){t===e.lastChild&&"DIV"===t.nodeName&&e.replaceChild(t.empty(),t),e.normalize(),St(e),Lt(e,!1),Rt(e),bt(e);for(var i=e,o=!0;i=i.getNextBlock();)i.fixCursor();S("willPaste",{fragment:e,preventDefault:function(){o=!1}}),o&&(n.insertTreeFragment(e),ot(),n.collapse(!1))}A(n),z(n,!0),Vt=!1}catch(s){r.didError(s)}},0)}});var Ft={8:"backspace",9:"tab",13:"enter",32:"space",46:"delete"},Ht=function(e){return function(t){t.preventDefault(),e()}},Wt=function(e){return function(t){t.preventDefault();var n=w();dt(e,null,n)?ut(null,{tag:e},n):ut({tag:e},null,n)}},_t=function(){try{var e,t=w(),n=t.startContainer;if(n.nodeType===s&&(n=n.parentNode),n.isInline()&&!n.textContent){do e=n.parentNode;while(e.isInline()&&!e.textContent&&(n=e));t.setStart(e,et.call(e.childNodes,n)),t.collapse(!0),e.removeChild(n),e.isBlock()||(e=e.getPreviousBlock()),e.fixCursor(),t.moveBoundariesDownTree(),A(t),z(t)}}catch(i){r.didError(i)}};C&&E("keyup",function(){var e=u.firstChild;"P"===e.nodeName&&(rt(w()),e.replaceWith(B("DIV",[e.empty()])),A(it()))});var Mt={enter:function(t){t.preventDefault();var n=w();if(n){st(n),St(n.startContainer),it(n),n.collapsed||n._deleteContents();var r,i=n.getStartBlock(),a=i?i.nodeName:"DIV",l=ht[a];if(!i)return n._insertNode(B("BR")),n.collapse(!1),A(n),z(n,!0),ot(),void 0;var d,c=n.startContainer,f=n.startOffset;if(l||(c===i&&(c=f?c.childNodes[f-1]:null,f=0,c&&("BR"===c.nodeName?c=c.nextSibling:f=c.getLength(),c&&"BR"!==c.nodeName||(d=B("DIV").fixCursor(),c?i.replaceChild(d,c):i.appendChild(d),c=d))),At(i,"DIV"),l="DIV",c||(c=i.firstChild),n.setStart(c,f),n.setEnd(c,f),i=n.getStartBlock()),!i.textContent){if(i.nearest("UL")||i.nearest("OL"))return gt(xt,n);if(i.nearest("BLOCKQUOTE"))return gt(vt,n)}for(r=pt(i,c,f);r.nodeType===o;){var p,N=r.firstChild;if("A"!==r.nodeName){for(;N&&N.nodeType===s&&!N.data&&(p=N.nextSibling,p&&"BR"!==p.nodeName);)N.detach(),N=p;if(!N||"BR"===N.nodeName||N.nodeType===s&&!h)break;r=N}else r.replaceWith(r.empty()),r=N}n=k(r,0),A(n),z(n,!0),r.nodeType===s&&(r=r.parentNode),r.offsetTop+r.offsetHeight>(e.documentElement.scrollTop||u.scrollTop)+u.offsetHeight&&r.scrollIntoView(!1),ot()}},backspace:function(e){var t=w();if(t.collapsed)if(t.startsAtBlockBoundary()){st(t),it(t),e.preventDefault();var n=t.getStartBlock(),r=n.getPreviousBlock();if(r){if(!r.isContentEditable)return r.detach(),void 0;for(r.mergeWithBlock(n,t),n=r.parentNode;n&&!n.nextSibling;)n=n.parentNode;n&&(n=n.nextSibling)&&n.mergeContainers(),A(t)}else{if(n.nearest("UL")||n.nearest("OL"))return gt(xt,t);if(n.nearest("BLOCKQUOTE"))return gt(mt,t);A(t),z(t,!0)}}else{var i=t.startContainer.data||"";T.test(i.charAt(t.startOffset-1))||(st(t),it(t),A(t)),setTimeout(_t,0)}else st(t),it(t),e.preventDefault(),t._deleteContents(),A(t),z(t,!0)},"delete":function(e){var t=w();if(t.collapsed)if(t.endsAtBlockBoundary()){st(t),it(t),e.preventDefault();var n=t.getStartBlock(),r=n.getNextBlock();if(r){if(!r.isContentEditable)return r.detach(),void 0;for(n.mergeWithBlock(r,t),r=n.parentNode;r&&!r.nextSibling;)r=r.parentNode;r&&(r=r.nextSibling)&&r.mergeContainers(),A(t),z(t,!0)}}else{var i=t.startContainer.data||"";T.test(i.charAt(t.startOffset))||(st(t),it(t),A(t)),setTimeout(_t,0)}else st(t),it(t),e.preventDefault(),t._deleteContents(),A(t),z(t,!0)},space:function(){var e=w();st(e),St(e.startContainer),it(e),A(e)},"ctrl-b":Wt("B"),"ctrl-i":Wt("I"),"ctrl-u":Wt("U"),"ctrl-y":Ht(lt),"ctrl-z":Ht(at),"ctrl-shift-z":Ht(lt)};E(h?"keypress":"keydown",function(e){var t=e.keyCode,n=Ft[t]||String.fromCharCode(t).toLowerCase(),r="";h&&46===e.which&&(n="."),t>111&&124>t&&(n="f"+(t-111)),e.altKey&&(r+="alt-"),(e.ctrlKey||e.metaKey)&&(r+="ctrl-"),e.shiftKey&&(r+="shift-"),n=r+n,Mt[n]&&Mt[n](e)});var zt=function(e){return function(){return e.apply(null,arguments),this}},Kt=function(e,t,n){return function(){return e(t,n),q(),this}};f.editor=r={didError:function(e){console.log(e)},_setPlaceholderTextNode:W,addEventListener:zt(E),removeEventListener:zt(D),focus:zt(q),blur:zt(G),getDocument:function(){return e},addStyles:function(t){if(t){var n=e.documentElement.firstChild,r=B("STYLE",{type:"text/css"});r.styleSheet?(n.appendChild(r),r.styleSheet.cssText=t):(r.appendChild(e.createTextNode(t)),n.appendChild(r))}return this},getHTML:function(e){var t,n,r,i,o,s=[];if(e&&(o=w())&&rt(o),y)for(t=u;t=t.getNextBlock();)t.textContent||t.querySelector("BR")||(n=B("BR"),t.appendChild(n),s.push(n));if(r=Z(),y)for(i=s.length;i--;)s[i].detach();return o&&it(o),r},setHTML:function(t){var n,r=e.createDocumentFragment(),i=B("DIV");i.innerHTML=t,r.appendChild(i.empty()),Lt(r,!0),Rt(r),At(r,"DIV");for(var o=r;o=o.getNextBlock();)o.fixCursor();for(;n=u.lastChild;)u.removeChild(n);u.appendChild(r),u.fixCursor(),Q=-1,Y=[],$=0,j=!1;var s=it()||k(u.firstChild,0);return st(s),it(s),v?L=s:A(s),z(s,!0),this},getSelectedText:function(){return w().getTextContent()},insertElement:zt(X),insertImage:function(e){var t=B("IMG",{src:e});return X(t),t},getPath:function(){return M},getSelection:w,setSelection:zt(A),undo:zt(at),redo:zt(lt),hasFormat:dt,changeFormat:zt(ut),bold:Kt(ut,{tag:"B"}),italic:Kt(ut,{tag:"I"}),underline:Kt(ut,{tag:"U"}),removeBold:Kt(ut,null,{tag:"B"}),removeItalic:Kt(ut,null,{tag:"I"}),removeUnderline:Kt(ut,null,{tag:"U"}),makeLink:function(t){t=encodeURI(t);var n=w();if(n.collapsed){var r=t.indexOf(":")+1;if(r)for(;"/"===t[r];)r+=1;n._insertNode(e.createTextNode(t.slice(r)))}return ut({tag:"A",attributes:{href:t}},{tag:"A"},n),q(),this},removeLink:function(){return ut(null,{tag:"A"},w(),!0),q(),this},setFontFace:function(e){return ut({tag:"SPAN",attributes:{"class":"font",style:"font-family: "+e+", sans-serif;"}},{tag:"SPAN",attributes:{"class":"font"}}),q(),this},setFontSize:function(e){return ut({tag:"SPAN",attributes:{"class":"size",style:"font-size: "+("number"==typeof e?e+"px":e)}},{tag:"SPAN",attributes:{"class":"size"}}),q(),this},setTextColour:function(e){return ut({tag:"SPAN",attributes:{"class":"colour",style:"color: "+e}},{tag:"SPAN",attributes:{"class":"colour"}}),q(),this},setHighlightColour:function(e){return ut({tag:"SPAN",attributes:{"class":"highlight",style:"background-color: "+e}},{tag:"SPAN",attributes:{"class":"highlight"}}),q(),this},setTextAlignment:function(e){return Nt(function(t){t.className=(t.className.split(/\s+/).filter(function(e){return!/align/.test(e)}).join(" ")+" align-"+e).trim(),t.style.textAlign=e},!0),q(),this},setTextDirection:function(e){return Nt(function(t){t.className=(t.className.split(/\s+/).filter(function(e){return!/dir/.test(e)}).join(" ")+" dir-"+e).trim(),t.dir=e},!0),q(),this},forEachBlock:zt(Nt),modifyBlocks:zt(gt),increaseQuoteLevel:Kt(gt,Ct),decreaseQuoteLevel:Kt(gt,mt),makeUnorderedList:Kt(gt,Tt),makeOrderedList:Kt(gt,Bt),removeList:Kt(gt,xt)},u.setAttribute("contenteditable","true"),r.setHTML(""),f.onEditorLoad&&(f.onEditorLoad(f.editor),f.onEditorLoad=null)}(document,UA,DOMTreeWalker);